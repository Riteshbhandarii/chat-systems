{% extends 'messaging/base.html' %}
{% block content %}

<div class="chat-container">
  <div class="star" style="width: 2px; height: 2px; left: 10%; animation: fallingStar 3s linear infinite;"></div>
<div class="star" style="width: 3px; height: 3px; left: 30%; animation: fallingStar 5s linear infinite; animation-delay: 1s;"></div>
<div class="star" style="width: 2px; height: 2px; left: 50%; animation: fallingStar 4s linear infinite; animation-delay: 2s;"></div>
<div class="star" style="width: 4px; height: 4px; left: 70%; animation: fallingStar 6s linear infinite;"></div>
<div class="star" style="width: 3px; height: 3px; left: 90%; animation: fallingStar 3.5s linear infinite; animation-delay: 0.5s;"></div>
<div class="star" style="width: 1px; height: 1px; left: 5%; animation: fallingStar 7s linear infinite; animation-delay: 3s;"></div>
<div class="star" style="width: 2px; height: 2px; left: 20%; animation: fallingStar 4.5s linear infinite;"></div>
<div class="star" style="width: 3px; height: 3px; left: 40%; animation: fallingStar 5.5s linear infinite; animation-delay: 1.5s;"></div>
<div class="star" style="width: 1px; height: 1px; left: 60%; animation: fallingStar 6.5s linear infinite; animation-delay: 2.5s;"></div>
<div class="star" style="width: 4px; height: 4px; left: 80%; animation: fallingStar 4s linear infinite;"></div>
  <div class="chat-header">
    <div class="left">
      <div class="settings-container">
        <button id="settings-button">Settings</button>
        <div id="settings-dropdown" class="settings-dropdown" style="display: none;">
          <button id="loadUserInfoBtn">Load My Info</button>
          <hr class="settings-divider">
          <button id="delete-account-button" onclick="deleteAccount()">Delete Account</button>
          <hr class="settings-divider">
          <button id="logout-button" onclick="window.location.href = '/logout/'">Logout</button>
          <div id="userInfoDisplay" style="margin-top: 10px;"></div>
        </div>
      </div>
    </div>
    <div class="center">
      <h2 class="chat-username"></h2>
      <div id="online-status" class="online-status-indicator" style="display: none;">
        <div class="status-dot offline"></div>
        <span class="status-text">Offline</span>
      </div>
    </div>
    <div class="right">
      <button id="contacts-button" onclick="toggleContacts()">Contacts</button>
    </div>
  </div>

  <!-- Rest of your HTML remains unchanged -->
  <div id="contacts-section" class="contacts-overlay" style="display: none;">
    <div class="contacts-content">
      <button id="close-contacts" onclick="toggleContacts()">Close</button>
      <div class="contacts-left">
        <h3>Search Users</h3>
        <form id="search-form" method="GET" action="{% url 'fetch_contacts' %}">
          {% csrf_token %}
          <input type="text" id="search-query" name="q" placeholder="Search for users..." />
          <button type="submit">Search</button>
        </form>
        <div id="contacts-list"></div>

        <h3>Create Group</h3>
        <button id="create-group-button" onclick="showCreateGroupForm()">Create Group</button>
        <div id="create-group-form" style="display: none; margin-top: 10px;">
          <form id="create-new-group-form">
            <input type="text" id="group-name-input" placeholder="Enter group name...">
            <h4>Select Friends</h4>
            <div id="group-friends-selection"></div>
            <button type="button" onclick="createGroup()">Create</button>
            <button type="button" onclick="cancelCreateGroup()">Cancel</button>
          </form>
        </div>

        <h3>Pending Friend Requests</h3>
        <div id="pending-requests"></div>
      </div>
      <div class="contacts-right">
        <h3>Your Friends</h3>
        <div id="friends-list"></div>
        <h3>Your Groups</h3>
        <div id="groups-list"></div>
      </div>
    </div>
  </div>

  <div id="chat-section" style="height: 100%; display: flex; flex-direction: column;">
    <div id="start-messaging" class="start-messaging"
         style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
      <h3>Welcome!</h3>
      <p>Your friends are waiting to hear from you!</p>
    </div>
    <div id="chat-box" class="chat-box" style="display: none;">
      <div class="messages-container"></div>
      <div id="message-input-section">
        <input type="text" id="chat-message-input" placeholder="Type your message...">
        <button id="send-button">Send</button>
      </div>
    </div>
  </div>
</div>

<script>
// Add event listener for settings button to toggle dropdown
document.getElementById('settings-button').addEventListener('click', function() {
  const dropdown = document.getElementById('settings-dropdown');
  dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
  // Close contacts section if open
  document.getElementById('contacts-section').style.display = 'none';
});

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
  const settingsContainer = document.querySelector('.settings-container');
  if (!settingsContainer.contains(event.target)) {
    document.getElementById('settings-dropdown').style.display = 'none';
  }
});

// Load user info button event listener
document.getElementById('loadUserInfoBtn').addEventListener('click', function() {
    fetch('/get_user_info/')
        .then(response => {
            if (!response.ok) {
                throw new Error("Network response was not OK");
            }
            return response.json();
        })
        .then(data => {
            downloadUserData(data);
        })
        .catch(error => {
            console.error('Error fetching user info:', error);
            const displayDiv = document.getElementById('userInfoDisplay');
            displayDiv.innerHTML = `<p class="error">Error downloading data</p>`;
            setTimeout(() => {
                displayDiv.innerHTML = '';
            }, 3000);
        });
});

// Function to download user data as JSON file
function downloadUserData(userData) {
    const now = new Date();
    const timestamp = now.toISOString().replace(/[:.]/g, '-');
    const dataStr = JSON.stringify(userData, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const downloadLink = document.createElement('a');
    downloadLink.href = URL.createObjectURL(blob);
    downloadLink.download = `user_data_${userData.username}_${timestamp}.json`;
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
    URL.revokeObjectURL(downloadLink.href);
    const displayDiv = document.getElementById('userInfoDisplay');
    displayDiv.innerHTML = `<p style="color: green;">Data downloaded successfully!</p>`;
    setTimeout(() => {
        displayDiv.innerHTML = '';
    }, 3000);
}

// Delete account function
function deleteAccount() {
    if (confirm("Are you sure you want to delete your account? This action is permanent.")) {
        fetch('/delete_account/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '/';
            } else {
                alert(data.error || "Failed to delete account.");
            }
        })
        .catch(error => {
            console.error("Error deleting account:", error);
            alert("Failed to delete account. Please try again.");
        });
    }
}

// CSRF token helper function
function getCSRFToken() {
    let csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]');
    if (csrfToken) {
        return csrfToken.value;
    }
    console.error("CSRF token input field not found!");
    return null;
}

// Rest of your JavaScript remains unchanged
let chatSocket = null;
let selectedGroupFriends = new Set();

function toggleContacts() {
  const contactsSection = document.getElementById("contacts-section");
  if (contactsSection.style.display === "none") {
    contactsSection.style.display = "flex";
    fetchContacts();
    fetchFriends();
    fetchGroups();
    fetchPendingRequests();
  } else {
    contactsSection.style.display = "none";
  }
}

function getCurrentTimeFormatted() {
  const now = new Date();
  let hours = now.getHours();
  const minutes = now.getMinutes().toString().padStart(2, '0');
  const ampm = hours >= 12 ? 'PM' : 'AM';
  hours = hours % 12;
  hours = hours ? hours : 12;
  return `${hours}:${minutes} ${ampm}`;
}

function updateOnlineStatus(isOnline, userId = null) {
  const statusDot = document.querySelector('.status-dot');
  const statusText = document.querySelector('.status-text');
  const statusContainer = document.getElementById('online-status');

  if (statusContainer) {
    statusContainer.style.display = 'flex';

    if (statusDot && statusText) {
      if (isOnline) {
        statusDot.classList.remove('offline');
        statusDot.classList.add('online');
        statusText.textContent = 'Online';
      } else {
        statusDot.classList.remove('online');
        statusDot.classList.add('offline');
        statusText.textContent = 'Offline';
      }
    }
  }
}

function fetchContacts() {
  const query = document.getElementById('search-query').value;
  fetch(`/fetch_contacts/?q=${encodeURIComponent(query)}`)
    .then(response => response.json())
    .then(data => {
      const contactsList = document.getElementById("contacts-list");
      contactsList.innerHTML = '';
      if (data.users && data.users.length > 0) {
        data.users.forEach(user => {
          const contactElement = document.createElement("div");
          contactElement.textContent = user.username;
          contactElement.classList.add('contact-item');

          const friendRequestButton = document.createElement("button");
          friendRequestButton.textContent = "Add";
          friendRequestButton.classList.add('add-button');
          friendRequestButton.onclick = function() {
            sendFriendRequest(user.id);
          };
          contactElement.appendChild(friendRequestButton);

          contactsList.appendChild(contactElement);
        });
      }
    })
    .catch(error => console.error("Error fetching contacts:", error));
}

function fetchFriends() {
  fetch('/get_friends/')
    .then(response => response.json())
    .then(data => {
      const friendsList = document.getElementById("friends-list");
      friendsList.innerHTML = '';
      if (data.friends && data.friends.length > 0) {
        data.friends.forEach(friend => {
          const friendElement = document.createElement("div");
          friendElement.textContent = friend.username;
          friendElement.classList.add('friend-item');

          const statusIndicator = document.createElement("div");
          statusIndicator.classList.add('friend-status-indicator');
          if (friend.is_online) {
            statusIndicator.classList.add('online');
            statusIndicator.title = "Online";
          } else {
            statusIndicator.classList.add('offline');
            statusIndicator.title = "Offline";
          }
          friendElement.appendChild(statusIndicator);

          const messageButton = document.createElement("button");
          messageButton.textContent = "Message";
          messageButton.classList.add('message-button');
          messageButton.onclick = function() {
            startChat(friend.id, friend.username, friend.is_online);
            toggleContacts();
          };
          friendElement.appendChild(messageButton);

          friendsList.appendChild(friendElement);
        });
      } else {
        friendsList.innerHTML = '<div class="no-friends">No friends yet</div>';
      }
    })
    .catch(error => console.error("Error fetching friends:", error));
}

function showCreateGroupForm() {
  const form = document.getElementById('create-group-form');
  form.style.display = 'block';
  selectedGroupFriends.clear();
  fetch('/get_friends/')
    .then(response => response.json())
    .then(data => {
      const selectionContainer = document.getElementById('group-friends-selection');
      selectionContainer.innerHTML = '';
      if (data.friends && data.friends.length > 0) {
        data.friends.forEach(friend => {
          const friendCheckbox = document.createElement('div');
          friendCheckbox.classList.add('friend-checkbox');
          friendCheckbox.innerHTML = `
            <input type="checkbox" id="friend-${friend.id}" value="${friend.id}">
            <label for="friend-${friend.id}">${friend.username}</label>
          `;
          friendCheckbox.querySelector('input').addEventListener('change', (e) => {
            if (e.target.checked) {
              selectedGroupFriends.add(friend.id);
            } else {
              selectedGroupFriends.delete(friend.id);
            }
          });
          selectionContainer.appendChild(friendCheckbox);
        });
      }
    })
    .catch(error => console.error("Error fetching friends for group:", error));
}

function cancelCreateGroup() {
  document.getElementById('create-group-form').style.display = 'none';
  const groupNameInput = document.getElementById('group-name-input');
  if (groupNameInput) {
    groupNameInput.value = '';
  }
  selectedGroupFriends.clear();
}

function createGroup() {
  const groupNameInput = document.getElementById('group-name-input');
  const groupName = groupNameInput.value.trim();
  
  if (!groupName) {
    alert("Please enter a group name");
    return;
  }
  
  if (selectedGroupFriends.size === 0) {
    alert("Please select at least one friend");
    return;
  }

  fetch('/create_group/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCSRFToken()
    },
    body: JSON.stringify({
      name: groupName,
      members: Array.from(selectedGroupFriends)
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert("Group created successfully");
      cancelCreateGroup();
      fetchGroups();
    } else {
      alert(data.error || "Failed to create group");
    }
  })
  .catch(error => {
    console.error("Error creating group:", error);
    alert("Failed to create group");
  });
}

function fetchGroups() {
  fetch('/get_groups/')
    .then(response => response.json())
    .then(data => {
      const groupsList = document.getElementById("groups-list");
      groupsList.innerHTML = '';
      if (data.groups && data.groups.length > 0) {
        data.groups.forEach(group => {
          const groupElement = document.createElement("div");
          groupElement.textContent = group.name;
          groupElement.classList.add('group-item');

          const messageButton = document.createElement("button");
          messageButton.textContent = "Message";
          messageButton.classList.add('message-button');
          messageButton.onclick = function() {
            startGroupChat(group.id, group.name);
            toggleContacts();
          };
          groupElement.appendChild(messageButton);

          groupsList.appendChild(groupElement);
        });
      } else {
        groupsList.innerHTML = '<div class="no-groups">No groups yet</div>';
      }
    })
    .catch(error => console.error("Error fetching groups:", error));
}

function startChat(friendId, friendUsername, isOnline = false) {
  console.log("Starting chat with friend ID:", friendId);

  if (chatSocket) {
    chatSocket.close();
  }

  chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/' + friendUsername + '/');

  chatSocket.onopen = function(e) {
    console.log("WebSocket connection established with", friendUsername);
  };

  chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    const messagesContainer = document.querySelector(".messages-container");

    if (data.type === "message_read") {
      const messageId = data.message_id;
      const messageElement = document.querySelector(`.message-wrapper[data-message-id="${messageId}"]`);
      if (messageElement) {
        const readReceipt = document.querySelector(".read-receipt");
        if (readReceipt) {
          readReceipt.innerHTML = "✓✓";
        }
      }
    } else {
      const messageElement = document.createElement("div");
      messageElement.className = "message-wrapper";
      messageElement.dataset.messageId = data.id;

      const messageContent = document.createElement("div");
      messageContent.style.padding = "10px 15px";
      messageContent.style.borderRadius = "18px";
      messageContent.style.maxWidth = "70%";
      messageContent.style.wordBreak = "break-word";
      messageContent.style.position = "relative";
      messageContent.textContent = data.message;

      const isCurrentUser = data.sender === "{{ request.user.username }}";
      if (isCurrentUser) {
        messageElement.className += " own-message";
        messageContent.style.backgroundColor = "#2c7be5";
        messageContent.style.color = "white";
        messageContent.style.borderTopRightRadius = "4px";
        messageContent.dataset.sent = "true";
      } else {
        messageContent.style.backgroundColor = "#f0f2f5";
        messageContent.style.color = "#050505";
        messageContent.style.borderTopLeftRadius = "4px";
        messageContent.dataset.seen = data.read ? "true" : "false";
      }

      const timestamp = document.createElement("div");
      timestamp.className = "message-timestamp";
      timestamp.textContent = data.timestamp ? new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : getCurrentTimeFormatted();
      messageContent.appendChild(timestamp);

      if (isCurrentUser) {
        const readReceipt = document.createElement("div");
        readReceipt.className = "read-receipt";
        readReceipt.innerHTML = data.read ? "✓✓" : "✓";
        messageContent.appendChild(readReceipt);
      }

      messageElement.appendChild(messageContent);
      messagesContainer.appendChild(messageElement);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;

      if (!isCurrentUser && !data.read) {
        setTimeout(() => {
          messageContent.dataset.seen = "true";
          chatSocket.send(JSON.stringify({
            "action": "mark_seen",
            "message_id": data.id
          }));
        }, 2000);
      }
    }
  };

  chatSocket.onclose = function() {
    console.error("WebSocket closed unexpectedly");
  };

  document.getElementById("contacts-section").style.display = "none";
  document.getElementById("start-messaging").style.display = "none";
  document.getElementById("chat-box").style.display = "flex";

  if (friendUsername) {
    const usernameElement = document.querySelector(".chat-header .center h2");
    usernameElement.textContent = friendUsername;
    usernameElement.classList.add('active-chat-user');

    updateOnlineStatus(isOnline, friendId);
    document.getElementById('online-status').style.display = 'flex';
  } else {
    document.querySelector(".chat-header .center h2").textContent = '';
    document.getElementById('online-status').style.display = 'none';
  }

  const messagesContainer = document.querySelector(".messages-container");
  messagesContainer.innerHTML = '';

  document.getElementById("chat-message-input").focus();
}

function startGroupChat(groupId, groupName) {
  console.log("Starting group chat with group ID:", groupId);

  if (chatSocket) {
    chatSocket.close();
  }

  chatSocket = new WebSocket('ws://' + window.location.host + '/ws/group_chat/' + groupId + '/');

  chatSocket.onopen = function(e) {
    console.log("WebSocket connection established for group", groupName);
  };

  chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    const messagesContainer = document.querySelector(".messages-container");

    const messageElement = document.createElement("div");
    messageElement.className = "message-wrapper";
    messageElement.dataset.messageId = data.id;

    const messageContent = document.createElement("div");
    messageContent.style.padding = "10px 15px";
    messageContent.style.borderRadius = "18px";
    messageContent.style.maxWidth = "70%";
    messageContent.style.wordBreak = "break-word";
    messageContent.style.position = "relative";
    messageContent.textContent = `${data.sender}: ${data.message}`;

    const isCurrentUser = data.sender === "{{ request.user.username }}";
    if (isCurrentUser) {
      messageElement.className += " own-message";
      messageContent.style.backgroundColor = "#2c7be5";
      messageContent.style.color = "white";
      messageContent.style.borderTopRightRadius = "4px";
    } else {
      messageContent.style.backgroundColor = "#f0f2f5";
      messageContent.style.color = "#050505";
      messageContent.style.borderTopLeftRadius = "4px";
    }

    const timestamp = document.createElement("div");
    timestamp.className = "message-timestamp";
    timestamp.textContent = data.timestamp ? new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : getCurrentTimeFormatted();
    messageContent.appendChild(timestamp);

    messageElement.appendChild(messageContent);
    messagesContainer.appendChild(messageElement);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  };

  chatSocket.onclose = function() {
    console.error("Group WebSocket closed unexpectedly");
  };

  document.getElementById("contacts-section").style.display = "none";
  document.getElementById("start-messaging").style.display = "none";
  document.getElementById("chat-box").style.display = "flex";

  const usernameElement = document.querySelector(".chat-header .center h2");
  usernameElement.textContent = groupName;
  usernameElement.classList.add('active-chat-user');
  document.getElementById('online-status').style.display = 'none';

  const messagesContainer = document.querySelector(".messages-container");
  messagesContainer.innerHTML = '';

  document.getElementById("chat-message-input").focus();
}

function fetchPendingRequests() {
  fetch('/pending_friend_requests/')
    .then(response => response.json())
    .then(data => {
      const pendingRequestsList = document.getElementById("pending-requests");
      pendingRequestsList.innerHTML = '';
      if (data.requests && data.requests.length > 0) {
        data.requests.forEach(request => {
          const requestElement = document.createElement("div");
          requestElement.textContent = `Friend request from ${request.sender_username}`;
          requestElement.classList.add('pending-request-item');
          requestElement.setAttribute('data-request-id', request.id);

          const acceptButton = document.createElement("button");
          acceptButton.textContent = "Accept";
          acceptButton.classList.add('accept-button');
          acceptButton.onclick = function(e) {
            e.stopPropagation();
            acceptFriendRequest(request.id, request.sender_username);
          };
          requestElement.appendChild(acceptButton);

          const rejectButton = document.createElement("button");
          rejectButton.textContent = "Reject";
          rejectButton.classList.add('reject-button');
          rejectButton.onclick = function(e) {
            e.stopPropagation();
            rejectFriendRequest(request.id);
          };
          requestElement.appendChild(rejectButton);

          pendingRequestsList.appendChild(requestElement);
        });
      } else {
        pendingRequestsList.innerHTML = '<div class="no-requests">No pending requests</div>';
      }
    })
    .catch(error => console.error("Error fetching pending requests:", error));
}

function sendFriendRequest(userId) {
  fetch(`/send_friend_request/${userId}/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCSRFToken()
    },
    credentials: 'same-origin'
  })
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        alert(data.error);
      } else {
        alert(data.message);
        const buttons = document.querySelectorAll(`.contact-item button[onclick="sendFriendRequest(${userId})"]`);
        buttons.forEach(button => {
          button.disabled = true;
          button.textContent = "Request Sent";
        });
        fetchContacts();
      }
    })
    .catch(error => {
      console.error("Error sending friend request:", error);
      alert("Failed to send friend request");
    });
}

function acceptFriendRequest(requestId, senderUsername) {
  console.log("Accepting request ID:", requestId);
  const token = getCSRFToken();
  if (!token) {
    alert("CSRF token missing. Cannot proceed.");
    return;
  }

  fetch(`/accept_friend_request/${requestId}/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': token
    },
    credentials: 'same-origin'
  })
    .then(response => {
      if (!response.ok) {
        return response.json().then(errData => {
          throw new Error(errData.error || `Server responded with status: ${response.status}`);
        }).catch(() => {
          throw new Error(`Network response was not ok. Status: ${response.status}`);
        });
      }
      return response.json();
    })
    .then(data => {
      console.log("Accept response data:", data);
      if (data.success) {
        const requestElement = document.querySelector(`#pending-requests div[data-request-id="${requestId}"]`);
        if (requestElement) {
          const container = document.getElementById("pending-requests");
          requestElement.remove();
          console.log("Removed pending request item:", requestId);

          if (container.children.length === 0) {
            container.innerHTML = '<div class="no-requests">No pending requests</div>';
          }

          fetchFriends();
        } else {
          console.warn("Could not find request element to remove for ID:", requestId);
          fetchFriends();
          alert("Friend accepted, but the list item could not be removed automatically.");
        }
      } else {
        alert(data.error || "Failed to accept friend request.");
      }
    })
    .catch(error => {
      console.error("Error accepting friend request:", error);
      alert("Failed to accept friend request. Please try again.");
    });
}

function rejectFriendRequest(requestId) {
  console.log("Rejecting request ID:", requestId);
  const token = getCSRFToken();
  if (!token) {
    alert("CSRF token missing. Cannot proceed.");
    return;
  }

  fetch(`/reject_friend_request/${requestId}/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': token
    },
    credentials: 'same-origin'
  })
    .then(response => {
      if (!response.ok) {
        return response.json().then(errData => {
          throw new Error(errData.error || `Server responded with status: ${response.status}`);
        }).catch(() => {
          throw new Error(`Network response was not ok. Status: ${response.status}`);
        });
      }
      return response.json();
    })
    .then(data => {
      console.log("Reject response data:", data);
      if (data.success) {
        const requestElement = document.querySelector(`#pending-requests div[data-request-id="${requestId}"]`);
        if (requestElement) {
          const container = document.getElementById("pending-requests");
          requestElement.remove();
          console.log("Removed pending request item:", requestId);

          if (container.children.length === 0) {
            container.innerHTML = '<div class="no-requests">No pending requests</div>';
          }
        } else {
          console.warn("Could not find request element to remove for ID:", requestId);
          alert("Friend request rejected, but the list item could not be removed automatically.");
        }
      } else {
        alert(data.error || "Failed to reject friend request.");
      }
    })
    .catch(error => {
      console.error("Error rejecting friend request:", error);
      alert("Failed to reject friend request. Please try again.");
    });
}

function sendMessage() {
  const messageInput = document.getElementById("chat-message-input");
  const message = messageInput.value.trim();
  if (message !== "" && chatSocket && chatSocket.readyState === WebSocket.OPEN) {
    chatSocket.send(JSON.stringify({
      "message": message,
      "timestamp": getCurrentTimeFormatted()
    }));
    messageInput.value = "";
  } else if (!chatSocket || chatSocket.readyState !== WebSocket.OPEN) {
    console.error("WebSocket not connected");
    alert("You are not connected. Please try again later.");
  }
}

document.getElementById("send-button").onclick = sendMessage;

document.getElementById("chat-message-input").addEventListener("keypress", function(event) {
  if (event.key === "Enter" && !event.shiftKey) {
    event.preventDefault();
    sendMessage();
  }
});

document.getElementById('search-form').addEventListener('submit', function(event) {
  event.preventDefault();
  fetchContacts();
});
</script>

<style>
  /* --- Star Background & Animations --- */
  body {
      background-color: #000000;
      background-image: radial-gradient(circle at top left, #222222 0%, #000000 70%);
      margin: 0;
      overflow-x: hidden;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      position: relative; /* For star positioning context */
  }

  .star {
      position: fixed; /* Fixed position to stay in the background */
      top: -20px; /* Start above the viewport */
      background: white;
      border-radius: 50%; /* Make them circular */
      opacity: 0.7; /* Slightly transparent */
      z-index: 0; /* Ensure stars are behind other content */
  }

  @keyframes fallingStar {
      to {
          transform: translateY(100vh); /* Animate down the full viewport height */
          opacity: 0; /* Fade out at the end */
      }
  }
  /* Keep your existing chat-container style */
  .chat-container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    background-color: black;
    /* Add overflow: hidden; if you want to strictly contain stars, */
    /* but fixed positioning usually handles this relative to viewport */
    /* overflow: hidden; */
  }

  /* Keep the rest of your styles - Modified for visual consistency */
  .chat-header {
    display: flex;
    align-items: center;
    background-color: #111111; /* Dark background */
    color: #ffffff; /* White text */
    padding: 15px 20px; /* Adjusted padding */
    box-shadow: 0 2px 5px rgba(255, 255, 255, 0.05); /* Subtle white shadow */
    position: relative; /* Ensure header stays above stars if needed */
    z-index: 1; /* Ensure header stays above stars */
    border-bottom: 1px solid #333333; /* Darker border */
  }

    .chat-header .left {
      width: auto;
    }

    .chat-header .center {
      flex-grow: 1;
      text-align: center;
      font-weight: bold;
      letter-spacing: 0.5px;
    }

    .chat-header .right {
      margin-left: auto;
      display: flex;
      align-items: center;
    }

    .settings-container {
      position: relative;
    }

    #settings-button, #contacts-button {
      background-color: #1c1c1c; /* Darker button background */
      color: #ffffff; /* White text */
      border: 1px solid #333333; /* Darker border */
      padding: 10px 15px; /* Adjusted padding */
      border-radius: 8px; /* More rounded */
      cursor: pointer;
      width: auto; /* Adjust width to content */
      height: auto; /* Adjust height to content */
      font-size: 15px; /* Slightly larger font */
      line-height: 1.2;
      text-align: center;
      box-sizing: border-box;
      margin: 5px;
      transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
    }

    #settings-button:hover, #contacts-button:hover {
      background-color: #333333;
      border-color: #ffffff;
    }

    .settings-dropdown {
      position: absolute;
      top: 100%;
      left: 5px;
      background-color: #1c1c1c; /* Dark background */
      border: 1px solid #333333; /* Dark border */
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(255, 255, 255, 0.05); /* Subtle white shadow */
      z-index: 1000;
      display: flex;
      flex-direction: column;
      width: 200px; /* Adjusted width */
      padding: 10px; /* Adjusted padding */
    }

    .settings-dropdown button {
      background-color: transparent;
      color: #ffffff;
      border: none;
      padding: 10px 15px; /* Adjusted padding */
      text-align: left;
      cursor: pointer;
      border-radius: 6px;
      width: 100%;
      height: auto; /* Adjust height */
      font-size: 15px; /* Slightly larger font */
      line-height: 1.2;
      box-sizing: border-box;
      margin: 2px 0;
      transition: background-color 0.2s ease;
    }

    .settings-dropdown button:hover {
      background-color: #333333;
    }

    .settings-divider {
      border: none;
      border-top: 1px solid #333333; /* Darker divider */
      margin: 8px 0;
    }

    .settings-dropdown #userInfoDisplay {
      padding: 10px;
      color: #aaaaaa;
      font-size: 14px;
    }

    .active-chat-user {
      display: inline-block;
      background: linear-gradient(to right, #4CAF50, #2196F3);
      color: #ffffff;
      padding: 8px 15px; /* Adjusted padding */
      border-radius: 20px;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(255, 255, 255, 0.05); /* Subtle white shadow */
      margin-bottom: 10px;
      font-size: 15px;
    }

    #create-group-button, #close-contacts {
      background-color: #1c1c1c; /* Darker button background */
      color: #ffffff; /* White text */
      border: 1px solid #333333; /* Darker border */
      padding: 10px 15px; /* Adjusted padding */
      border-radius: 8px; /* More rounded */
      cursor: pointer;
      width: auto; /* Adjust width to content */
      height: auto; /* Adjust height to content */
      font-size: 15px; /* Slightly larger font */
      line-height: 1.2;
      text-align: center;
      box-sizing: border-box;
      margin: 5px;
      transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
    }

    #create-group-button:hover, #close-contacts:hover {
      background-color: #333333;
      border-color: #ffffff;
    }

    .contacts-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8); /* More opaque background */
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .contacts-content {
      background-color: #111111; /* Dark background */
      width: 95%; /* Slightly wider */
      max-width: 700px; /* Max width */
      height: 90%;
      border-radius: 12px; /* More rounded */
      display: flex;
      overflow: hidden;
      position: relative;
      box-shadow: 0 8px 20px rgba(255, 255, 255, 0.05); /* More prominent shadow */
      border: 1px solid #333333; /* Darker border */
    }

    #close-contacts {
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 1.5rem;
      color: #aaaaaa;
      background: transparent;
      border: none;
      cursor: pointer;
      transition: color 0.2s ease;
    }

    #close-contacts:hover {
      color: #ffffff;
    }

    .contacts-left, .contacts-right {
      padding: 20px;
      overflow-y: auto;
      color: #ffffff; /* White text */
    }

    .contacts-left {
      width: 40%;
      border-right: 1px solid #333333; /* Darker border */
    }

    .contacts-right {
      width: 60%;
    }

    #pending-requests {
      margin-top: 20px;
      border-top: 1px solid #333333; /* Darker border */
      padding-top: 15px;
    }

    .pending-request-item {
      padding: 10px 0;
      border-bottom: 1px solid #333333; /* Darker border */
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .pending-request-item span {
      flex-grow: 1;
    }

    .accept-button, .reject-button, .add-button {
      background-color: #222222; /* Darker button background */
      color: #ffffff; /* White text */
      border: 1px solid #444444; /* Darker border */
      padding: 8px 12px; /* Adjusted padding */
      border-radius: 6px; /* More rounded */
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
      margin-left: 5px;
    }

    .accept-button {
      background-color: #4CAF50;
      border-color: #4CAF50;
    }

    .reject-button {
      background-color: #f44336;
      border-color: #f44336;
    }

    .add-button:hover {
      background-color: #333333;
      border-color: #ffffff;
    }

    #contacts-list, #groups-list, #friends-list {
      list-style-type: none;
      padding: 0;
    }

    .contact-item, .group-item, .friend-item {
      padding: 10px 0;
      border-bottom: 1px solid #333333; /* Darker border */
      cursor: pointer;
      transition: background-color 0.2s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .contact-item:hover, .group-item:hover, .friend-item:hover {
      background-color: #1c1c1c; /* Darker hover */
    }

    .start-messaging {
      text-align: center;
      margin: auto;
      padding: 20px;
      color: #aaaaaa;
    }

    .start-messaging h3 {
      font-size: 24px;
      margin-bottom: 10px;
    }

    .start-messaging p {
      font-size: 16px;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background-color: #555555 !important;
      border-color: #777777 !important;
    }

    #chat-box {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 200px);
      width: 70%;
      margin: 20px auto;
      background-color: rgb(232, 232, 234); /* Kept as requested */
      border-radius: 8px; /* Kept as requested */
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Kept as requested */
      position: relative;
      z-index: 1; /* Ensure chatbox is above the stars */
      /* border: 1px solid #333333; Removed potentially conflicting border */
    }

    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      margin-bottom: 70px;
      scrollbar-width: thin;
      scrollbar-color: rgba(0,0,0,0.2) transparent; /* Kept as requested */
    }

    .messages-container::-webkit-scrollbar {
      width: 6px; /* Kept as requested */
    }

    .messages-container::-webkit-scrollbar-track {
      background: transparent; /* Kept as requested */
    }

    .messages-container::-webkit-scrollbar-thumb {
      background-color: rgba(0,0,0,0.2); /* Kept as requested */
      border-radius: 3px; /* Kept as requested */
    }

    #message-input-section {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: white; /* Kept as requested */
      padding: 12px; /* Kept as requested */
      border-bottom-left-radius: 8px; /* Kept as requested */
      border-bottom-right-radius: 8px; /* Kept as requested */
      display: flex;
      align-items: center;
      gap: 10px; /* Kept as requested */
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05); /* Kept as requested */
      z-index: 2; /* Ensure input section is above the stars */
      /* border-top: 1px solid #333333; Removed potentially conflicting border */
    }

    #chat-message-input {
      flex: 1;
      padding: 12px; /* Kept as requested */
      font-size: 16px; /* Kept as requested */
      border: 1px solid #ccc; /* Kept as requested */
      border-radius: 20px; /* Kept as requested */
    }

    #send-button {
      flex-shrink: 0;
      background-color: #707d8c; /* Kept as requested */
      color: white; /* Kept as requested */
      border: none; /* Kept as requested */
      padding: 10px 20px; /* Kept as requested */
      border-radius: 20px; /* Kept as requested */
      cursor: pointer; /* Kept as requested */
      transition: background-color 0.2s; /* Kept as requested */
    }

    #send-button:hover {
      background-color: #45a049; /* Kept as requested */
    }

    .message-wrapper {
      display: flex;
      margin-bottom: 16px; /* Kept as requested */
      width: 100%; /* Kept as requested */
    }

    .message-wrapper.own-message {
      justify-content: flex-end; /* Kept as requested */
    }

    .message-timestamp {
      font-size: 10px; /* Kept as requested */
      opacity: 0.7; /* Kept as requested */
      margin-top: 4px; /* Kept as requested */
      position: absolute; /* Kept as requested */
      bottom: 2px; /* Kept as requested */
      right: 8px; /* Kept as requested */
    }

    .read-receipt {
      font-size: 10px; /* Kept as requested */
      opacity: 0.7; /* Kept as requested */
      position: absolute;
     }
      </style>
  {% endblock %}

