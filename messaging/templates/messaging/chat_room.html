{% extends 'messaging/base.html' %}
{% block content %}
<div class="chat-container">
  <div class="star" style="width: 2px; height: 2px; left: 10%; animation: fallingStar 3s linear infinite;"></div>
  <div class="star" style="width: 3px; height: 3px; left: 30%; animation: fallingStar 5s linear infinite; animation-delay: 1s;"></div>
  <div class="star" style="width: 2px; height: 2px; left: 50%; animation: fallingStar 4s linear infinite; animation-delay: 2s;"></div>
  <div class="star" style="width: 4px; height: 4px; left: 70%; animation: fallingStar 6s linear infinite;"></div>
  <div class="star" style="width: 3px; height: 3px; left: 90%; animation: fallingStar 3.5s linear infinite; animation-delay: 0.5s;"></div>
  <div class="star" style="width: 1px; height: 1px; left: 5%; animation: fallingStar 7s linear infinite; animation-delay: 3s;"></div>
  <div class="star" style="width: 2px; height: 2px; left: 20%; animation: fallingStar 4.5s linear infinite;"></div>
  <div class="star" style="width: 3px; height: 3px; left: 40%; animation: fallingStar 5.5s linear infinite; animation-delay: 1.5s;"></div>
  <div class="star" style="width: 1px; height: 1px; left: 60%; animation: fallingStar 6.5s linear infinite; animation-delay: 2.5s;"></div>
  <div class="star" style="width: 4px; height: 4px; left: 80%; animation: fallingStar 4s linear infinite;"></div>
  <div class="chat-header">
    <div class="left">
      <div class="settings-container">
        <button id="settings-button">Settings</button>
        <div id="settings-dropdown" class="settings-dropdown" style="display: none;">
          <button id="loadUserInfoBtn">Load My Info</button>
          <hr class="settings-divider">
          <button id="delete-account-button">Delete Account</button>
          <hr class="settings-divider">
          <button id="logout-button" onclick="window.location.href = '/logout/'">Logout</button>
          <div id="userInfoDisplay" style="margin-top: 10px;"></div>
        </div>
      </div>
    </div>
    <div class="center">
      <h2 class="chat-username"></h2>
      <div id="online-status" class="online-status-indicator" style="display: none;">
        <div class="status-dot offline"></div>
        <span class="status-text">Offline</span>
      </div>
    </div>
    <div class="right">
      <button id="contacts-button" onclick="toggleContacts()">Contacts</button>
      <div class="notifications-container">
        <button id="notifications-button">Notifications <span id="notification-badge" class="notification-badge" style="display: none;">0</span></button>
        <div id="notifications-dropdown" class="notifications-dropdown" style="display: none;"></div>
      </div>
    </div>
  </div>

  <div id="contacts-section" class="contacts-overlay" style="display: none;">
    <div class="contacts-content">
      <button id="close-contacts" onclick="toggleContacts()">Close</button>
      <div class="contacts-left">
        <h3>Search Users</h3>
        <form id="search-form" method="GET" action="{% url 'fetch_contacts' %}">
          {% csrf_token %}
          <input type="text" id="search-query" name="q" placeholder="Search for users..." />
          <button type="submit">Search</button>
        </form>
        <div id="contacts-list"></div>

        <h3>Create Group</h3>
        <button id="create-group-button" onclick="showCreateGroupForm()">Create Group</button>
        <div id="create-group-form" style="display: none; margin-top: 10px;">
          <form id="create-new-group-form">
            <input type="text" id="group-name-input" placeholder="Enter group name...">
            <h4>Select Friends</h4>
            <div id="group-friends-selection"></div>
            <button type="button" onclick="createGroup()">Create</button>
            <button type="button" onclick="cancelCreateGroup()">Cancel</button>
          </form>
        </div>

        <h3>Pending Friend Requests</h3>
        <div id="pending-requests"></div>
      </div>
      <div class="contacts-right">
        <h3>Your Friends</h3>
        <div id="friends-list"></div>
        <h3>Your Groups</h3>
        <div id="groups-list"></div>
      </div>
    </div>
  </div>

  <div id="chat-section" style="height: 100%; display: flex; flex-direction: column;">
    <div id="start-messaging" class="start-messaging"
         style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
      <h3>Welcome!</h3>
      <p>Your friends are waiting to hear from you!</p>
    </div>
    <div id="chat-box" class="chat-box" style="display: none;">
      <div class="messages-container"></div>
      <div id="message-input-section">
        <input type="text" id="chat-message-input" placeholder="Type your message...">
        <button id="send-button">Send</button>
      </div>
    </div>
  </div>
</div>

<script>
// Global array to store unread messages
let unreadMessages = [];
let chatSocket = null;
let selectedGroupFriends = new Set();

// Add event listener for settings button to toggle dropdown
document.getElementById('settings-button').addEventListener('click', function() {
  const dropdown = document.getElementById('settings-dropdown');
  dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
  document.getElementById('contacts-section').style.display = 'none';
  document.getElementById('notifications-dropdown').style.display = 'none';
});

// Add event listener for notifications button to toggle dropdown
document.getElementById('notifications-button').addEventListener('click', function() {
  const dropdown = document.getElementById('notifications-dropdown');
  dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
  document.getElementById('settings-dropdown').style.display = 'none';
  document.getElementById('contacts-section').style.display = 'none';
});

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
  const settingsContainer = document.querySelector('.settings-container');
  const notificationsContainer = document.querySelector('.notifications-container');
  if (!settingsContainer.contains(event.target)) {
    document.getElementById('settings-dropdown').style.display = 'none';
  }
  if (!notificationsContainer.contains(event.target)) {
    document.getElementById('notifications-dropdown').style.display = 'none';
  }
});

// Load user info button event listener
document.getElementById('loadUserInfoBtn').addEventListener('click', function() {
    fetch('/get_user_info/')
        .then(response => {
            if (!response.ok) {
                throw new Error("Network response was not OK");
            }
            return response.json();
        })
        .then(data => {
            downloadUserData(data);
        })
        .catch(error => {
            console.error('Error fetching user info:', error);
            const displayDiv = document.getElementById('userInfoDisplay');
            displayDiv.innerHTML = `<p class="error">Error downloading data</p>`;
            setTimeout(() => {
                displayDiv.innerHTML = '';
            }, 3000);
        });
});

// Delete account button event listener
document.getElementById('delete-account-button').addEventListener('click', function() {
    deleteAccount();
});

// Function to download user data as JSON file
function downloadUserData(userData) {
    const now = new Date();
    const timestamp = now.toISOString().replace(/[:.]/g, '-');
    const dataStr = JSON.stringify(userData, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const downloadLink = document.createElement('a');
    downloadLink.href = URL.createObjectURL(blob);
    downloadLink.download = `user_data_${userData.username}_${timestamp}.json`;
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
    URL.revokeObjectURL(downloadLink.href);
    const displayDiv = document.getElementById('userInfoDisplay');
    displayDiv.innerHTML = `<p style="color: green;">Data downloaded successfully!</p>`;
    setTimeout(() => {
        displayDiv.innerHTML = '';
    }, 3000);
}

// Delete account function
function deleteAccount() {
    if (confirm("Are you sure you want to delete your account? This action is permanent.")) {
        const token = getCSRFToken();
        if (!token) {
            console.error("CSRF token missing. Cannot proceed with account deletion.");
            alert("CSRF token missing. Please refresh the page and try again.");
            return;
        }
        console.log("Attempting to delete account with CSRF token:", token);
        fetch('/delete_account/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': token,
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({})
        })
        .then(response => {
            console.log("Delete account response status:", response.status);
            if (response.ok) {
                alert("Account deleted successfully.");
                window.location.href = '/';
                return;
            } else {
                return response.json().then(errData => {
                    throw new Error(errData.error || `Server responded with status: ${response.status}`);
                }).catch(() => {
                    throw new Error(`Network response was not ok. Status: ${response.status}`);
                });
            }
        })
        .catch(error => {
            console.error("Error deleting account:", error.message);
            alert(`Failed to delete account: ${error.message}. Please try again or contact support.`);
        });
    }
}

// CSRF token helper function
function getCSRFToken() {
    let csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]');
    if (csrfToken) {
        return csrfToken.value;
    }
    const name = 'csrftoken';
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [key, value] = cookie.trim().split('=');
        if (key === name) {
            return decodeURIComponent(value);
        }
    }
    console.error("CSRF token not found in form or cookies!");
    return null;
}

// Function to update notification badge and dropdown
function updateNotifications() {
    const badge = document.getElementById('notification-badge');
    const dropdown = document.getElementById('notifications-dropdown');
    badge.textContent = unreadMessages.length;
    badge.style.display = unreadMessages.length > 0 ? 'inline-block' : 'none';

    dropdown.innerHTML = '';
    if (unreadMessages.length === 0) {
        dropdown.innerHTML = '<div class="no-notifications">No new messages</div>';
    } else {
        unreadMessages.forEach(msg => {
            const notification = document.createElement('div');
            notification.classList.add('notification-item');
            const sender = msg.isGroup ? msg.group_name : msg.sender;
            const truncatedMessage = msg.message.length > 50 ? msg.message.substring(0, 47) + '...' : msg.message;
            notification.innerHTML = `
                <strong>${sender}</strong>: ${truncatedMessage}<br>
                <span class="notification-timestamp">${new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
            `;
            notification.addEventListener('click', () => {
                if (msg.isGroup) {
                    startGroupChat(msg.group_id, msg.group_name);
                } else {
                    startChat(msg.friend_id, msg.sender, false);
                }
                // Remove the notification
                unreadMessages = unreadMessages.filter(m => m.id !== msg.id);
                updateNotifications();
                document.getElementById('notifications-dropdown').style.display = 'none';
            });
            dropdown.appendChild(notification);
        });
    }
}

// Fetch unread messages on page load
function fetchUnreadMessages() {
    fetch('/get_unread_messages/')
        .then(response => response.json())
        .then(data => {
            unreadMessages = data.messages || [];
            updateNotifications();
        })
        .catch(error => console.error('Error fetching unread messages:', error));
}

// Call on page load
document.addEventListener('DOMContentLoaded', () => {
    fetchUnreadMessages();
});

// Rest of your JavaScript
function toggleContacts() {
    const contactsSection = document.getElementById("contacts-section");
    if (contactsSection.style.display === "none") {
        contactsSection.style.display = "flex";
        fetchContacts();
        fetchFriends();
        fetchGroups();
        fetchPendingRequests();
    } else {
        contactsSection.style.display = "none";
    }
    document.getElementById('notifications-dropdown').style.display = 'none';
}

function getCurrentTimeFormatted() {
    const now = new Date();
    let hours = now.getHours();
    const minutes = now.getMinutes().toString().padStart(2, '0');
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12;
    return `${hours}:${minutes} ${ampm}`;
}

function updateOnlineStatus(isOnline, userId = null) {
    const statusDot = document.querySelector('.status-dot');
    const statusText = document.querySelector('.status-text');
    const statusContainer = document.getElementById('online-status');

    if (statusContainer) {
        statusContainer.style.display = 'flex';
        if (statusDot && statusText) {
            if (isOnline) {
                statusDot.classList.remove('offline');
                statusDot.classList.add('online');
                statusText.textContent = 'Online';
            } else {
                statusDot.classList.remove('online');
                statusDot.classList.add('offline');
                statusText.textContent = 'Offline';
            }
        }
    }
}

function fetchContacts() {
    const query = document.getElementById('search-query').value;
    fetch(`/fetch_contacts/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            const contactsList = document.getElementById("contacts-list");
            contactsList.innerHTML = '';
            if (data.users && data.users.length > 0) {
                data.users.forEach(user => {
                    const contactElement = document.createElement("div");
                    contactElement.textContent = user.username;
                    contactElement.classList.add('contact-item');

                    const friendRequestButton = document.createElement("button");
                    friendRequestButton.textContent = "Add";
                    friendRequestButton.classList.add('add-button');
                    friendRequestButton.onclick = function() {
                        sendFriendRequest(user.id);
                    };
                    contactElement.appendChild(friendRequestButton);

                    contactsList.appendChild(contactElement);
                });
            }
        })
        .catch(error => console.error("Error fetching contacts:", error));
}

function fetchFriends() {
    fetch('/get_friends/')
        .then(response => response.json())
        .then(data => {
            const friendsList = document.getElementById("friends-list");
            friendsList.innerHTML = '';
            if (data.friends && data.friends.length > 0) {
                data.friends.forEach(friend => {
                    const friendElement = document.createElement("div");
                    friendElement.textContent = friend.username;
                    friendElement.classList.add('friend-item');

                    const statusIndicator = document.createElement("div");
                    statusIndicator.classList.add('friend-status-indicator');
                    if (friend.is_online) {
                        statusIndicator.classList.add('online');
                        statusIndicator.title = "Online";
                    } else {
                        statusIndicator.classList.add('offline');
                        statusIndicator.title = "Offline";
                    }
                    friendElement.appendChild(statusIndicator);

                    const messageButton = document.createElement("button");
                    messageButton.textContent = "Message";
                    messageButton.classList.add('message-button');
                    messageButton.onclick = function() {
                        startChat(friend.id, friend.username, friend.is_online);
                        toggleContacts();
                    };
                    friendElement.appendChild(messageButton);

                    friendsList.appendChild(friendElement);
                });
            } else {
                friendsList.innerHTML = '<div class="no-friends">No friends yet</div>';
            }
        })
        .catch(error => console.error("Error fetching friends:", error));
}

function showCreateGroupForm() {
    const form = document.getElementById('create-group-form');
    form.style.display = 'block';
    selectedGroupFriends.clear();
    fetch('/get_friends/')
        .then(response => response.json())
        .then(data => {
            const selectionContainer = document.getElementById('group-friends-selection');
            selectionContainer.innerHTML = '';
            if (data.friends && data.friends.length > 0) {
                data.friends.forEach(friend => {
                    const friendCheckbox = document.createElement('div');
                    friendCheckbox.classList.add('friend-checkbox');
                    friendCheckbox.innerHTML = `
                        <input type="checkbox" id="friend-${friend.id}" value="${friend.id}">
                        <label for="friend-${friend.id}">${friend.username}</label>
                    `;
                    friendCheckbox.querySelector('input').addEventListener('change', (e) => {
                        if (e.target.checked) {
                            selectedGroupFriends.add(friend.id);
                        } else {
                            selectedGroupFriends.delete(friend.id);
                        }
                    });
                    selectionContainer.appendChild(friendCheckbox);
                });
            }
        })
        .catch(error => console.error("Error fetching friends for group:", error));
}

function cancelCreateGroup() {
    document.getElementById('create-group-form').style.display = 'none';
    const groupNameInput = document.getElementById('group-name-input');
    if (groupNameInput) {
        groupNameInput.value = '';
    }
    selectedGroupFriends.clear();
}

function createGroup() {
    const groupNameInput = document.getElementById('group-name-input');
    const groupName = groupNameInput.value.trim();
    
    if (!groupName) {
        alert("Please enter a group name");
        return;
    }
    
    if (selectedGroupFriends.size === 0) {
        alert("Please select at least one friend");
        return;
    }

    fetch('/create_group/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            name: groupName,
            members: Array.from(selectedGroupFriends)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert("Group created successfully");
            cancelCreateGroup();
            fetchGroups();
        } else {
            alert(data.error || "Failed to create group");
        }
    })
    .catch(error => {
        console.error("Error creating group:", error);
        alert("Failed to create group");
    });
}

function fetchGroups() {
    fetch('/get_groups/')
        .then(response => response.json())
        .then(data => {
            const groupsList = document.getElementById("groups-list");
            groupsList.innerHTML = '';
            if (data.groups && data.groups.length > 0) {
                data.groups.forEach(group => {
                    const groupElement = document.createElement("div");
                    groupElement.textContent = group.name;
                    groupElement.classList.add('group-item');

                    const messageButton = document.createElement("button");
                    messageButton.textContent = "Message";
                    messageButton.classList.add('message-button');
                    messageButton.onclick = function() {
                        startGroupChat(group.id, group.name);
                        toggleContacts();
                    };
                    groupElement.appendChild(messageButton);

                    groupsList.appendChild(groupElement);
                });
            } else {
                groupsList.innerHTML = '<div class="no-groups">No groups yet</div>';
            }
        })
        .catch(error => console.error("Error fetching groups:", error));
}

function startChat(friendId, friendUsername, isOnline = false) {
    console.log("Starting chat with friend ID:", friendId);

    if (chatSocket) {
        chatSocket.close();
    }

    chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/' + friendUsername + '/');

    chatSocket.onopen = function(e) {
        console.log("WebSocket connection established with", friendUsername);
    };

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const messagesContainer = document.querySelector(".messages-container");

        if (data.type === "message_read") {
            const messageId = data.message_id;
            const messageElement = document.querySelector(`.message-wrapper[data-message-id="${messageId}"]`);
            if (messageElement) {
                const readReceipt = document.querySelector(".read-receipt");
                if (readReceipt) {
                    readReceipt.innerHTML = "✓✓";
                }
            }
        } else {
            const messageElement = document.createElement("div");
            messageElement.className = "message-wrapper";
            messageElement.dataset.messageId = data.id;

            const messageContent = document.createElement("div");
            messageContent.style.padding = "10px 15px";
            messageContent.style.borderRadius = "18px";
            messageContent.style.maxWidth = "70%";
            messageContent.style.wordBreak = "break-word";
            messageContent.style.position = "relative";
            messageContent.textContent = data.message;

            const isCurrentUser = data.sender === "{{ request.user.username }}";
            if (isCurrentUser) {
                messageElement.className += " own-message";
                messageContent.style.backgroundColor = "#2c7be5";
                messageContent.style.color = "white";
                messageContent.style.borderTopRightRadius = "4px";
                messageContent.dataset.sent = "true";
            } else {
                messageContent.style.backgroundColor = "#f0f2f5";
                messageContent.style.color = "#050505";
                messageContent.style.borderTopLeftRadius = "4px";
                messageContent.dataset.seen = data.read ? "true" : "false";
                // Add to unread messages if not read and not in current chat
                if (!data.read && document.querySelector('.chat-username').textContent !== data.sender) {
                    unreadMessages.push({
                        id: data.id,
                        sender: data.sender,
                        friend_id: friendId,
                        message: data.message,
                        timestamp: data.timestamp,
                        isGroup: false
                    });
                    updateNotifications();
                }
            }

            const timestamp = document.createElement("div");
            timestamp.className = "message-timestamp";
            timestamp.textContent = data.timestamp ? new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : getCurrentTimeFormatted();
            messageContent.appendChild(timestamp);

            if (isCurrentUser) {
                const readReceipt = document.createElement("div");
                readReceipt.className = "read-receipt";
                readReceipt.innerHTML = data.read ? "✓✓" : "✓";
                messageContent.appendChild(readReceipt);
            }

            messageElement.appendChild(messageContent);
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            if (!isCurrentUser && !data.read) {
                setTimeout(() => {
                    messageContent.dataset.seen = "true";
                    chatSocket.send(JSON.stringify({
                        "action": "mark_seen",
                        "message_id": data.id
                    }));
                    // Remove from unread messages
                    unreadMessages = unreadMessages.filter(m => m.id !== data.id);
                    updateNotifications();
                }, 2000);
            }
        }
    };

    chatSocket.onclose = function() {
        console.error("WebSocket closed unexpectedly");
    };

    document.getElementById("contacts-section").style.display = "none";
    document.getElementById("start-messaging").style.display = "none";
    document.getElementById("chat-box").style.display = "flex";

    if (friendUsername) {
        const usernameElement = document.querySelector(".chat-header .center h2");
        usernameElement.textContent = friendUsername;
        usernameElement.classList.add('active-chat-user');

        updateOnlineStatus(isOnline, friendId);
        document.getElementById('online-status').style.display = 'flex';
    } else {
        document.querySelector(".chat-header .center h2").textContent = '';
        document.getElementById('online-status').style.display = 'none';
    }

    const messagesContainer = document.querySelector(".messages-container");
    messagesContainer.innerHTML = '';

    // Clear unread messages for this chat
    unreadMessages = unreadMessages.filter(msg => msg.sender !== friendUsername && !msg.isGroup);
    updateNotifications();

    document.getElementById("chat-message-input").focus();
}

function startGroupChat(groupId, groupName) {
    console.log("Starting group chat with group ID:", groupId);

    if (chatSocket) {
        chatSocket.close();
    }

    chatSocket = new WebSocket('ws://' + window.location.host + '/ws/group_chat/' + groupId + '/');

    chatSocket.onopen = function(e) {
        console.log("WebSocket connection established for group", groupName);
    };

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const messagesContainer = document.querySelector(".messages-container");

        const messageElement = document.createElement("div");
        messageElement.className = "message-wrapper";
        messageElement.dataset.messageId = data.id;

        const messageContent = document.createElement("div");
        messageContent.style.padding = "10px 15px";
        messageContent.style.borderRadius = "18px";
        messageContent.style.maxWidth = "70%";
        messageContent.style.wordBreak = "break-word";
        messageContent.style.position = "relative";
        messageContent.textContent = `${data.sender}: ${data.message}`;

        const isCurrentUser = data.sender === "{{ request.user.username }}";
        if (isCurrentUser) {
            messageElement.className += " own-message";
            messageContent.style.backgroundColor = "#2c7be5";
            messageContent.style.color = "white";
            messageContent.style.borderTopRightRadius = "4px";
        } else {
            messageContent.style.backgroundColor = "#f0f2f5";
            messageContent.style.color = "#050505";
            messageContent.style.borderTopLeftRadius = "4px";
            // Add to unread messages if not in current group chat
            if (document.querySelector('.chat-username').textContent !== groupName) {
                unreadMessages.push({
                    id: data.id,
                    sender: data.sender,
                    message: data.message,
                    timestamp: data.timestamp,
                    isGroup: true,
                    group_id: groupId,
                    group_name: groupName
                });
                updateNotifications();
            }
        }

        const timestamp = document.createElement("div");
        timestamp.className = "message-timestamp";
        timestamp.textContent = data.timestamp ? new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : getCurrentTimeFormatted();
        messageContent.appendChild(timestamp);

        messageElement.appendChild(messageContent);
        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    };

    chatSocket.onclose = function() {
        console.error("Group WebSocket closed unexpectedly");
    };

    document.getElementById("contacts-section").style.display = "none";
    document.getElementById("start-messaging").style.display = "none";
    document.getElementById("chat-box").style.display = "flex";

    const usernameElement = document.querySelector(".chat-header .center h2");
    usernameElement.textContent = groupName;
    usernameElement.classList.add('active-chat-user');
    document.getElementById('online-status').style.display = 'none';

    const messagesContainer = document.querySelector(".messages-container");
    messagesContainer.innerHTML = '';

    // Clear unread messages for this group
    unreadMessages = unreadMessages.filter(msg => !(msg.isGroup && msg.group_name === groupName));
    updateNotifications();

    document.getElementById("chat-message-input").focus();
}

function fetchPendingRequests() {
    fetch('/pending_friend_requests/')
        .then(response => response.json())
        .then(data => {
            const pendingRequestsList = document.getElementById("pending-requests");
            pendingRequestsList.innerHTML = '';
            if (data.requests && data.requests.length > 0) {
                data.requests.forEach(request => {
                    const requestElement = document.createElement("div");
                    requestElement.textContent = `Friend request from ${request.sender_username}`;
                    requestElement.classList.add('pending-request-item');
                    requestElement.setAttribute('data-request-id', request.id);

                    const acceptButton = document.createElement("button");
                    acceptButton.textContent = "Accept";
                    acceptButton.classList.add('accept-button');
                    acceptButton.onclick = function(e) {
                        e.stopPropagation();
                        acceptFriendRequest(request.id, request.sender_username);
                    };
                    requestElement.appendChild(acceptButton);

                    const rejectButton = document.createElement("button");
                    rejectButton.textContent = "Reject";
                    rejectButton.classList.add('reject-button');
                    rejectButton.onclick = function(e) {
                        e.stopPropagation();
                        rejectFriendRequest(request.id);
                    };
                    requestElement.appendChild(rejectButton);

                    pendingRequestsList.appendChild(requestElement);
                });
            } else {
                pendingRequestsList.innerHTML = '<div class="no-requests">No pending requests</div>';
            }
        })
        .catch(error => console.error("Error fetching pending requests:", error));
}

function sendFriendRequest(userId) {
    fetch(`/send_friend_request/${userId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        credentials: 'same-origin'
    })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                alert(data.message);
                const buttons = document.querySelectorAll(`.contact-item button[onclick="sendFriendRequest(${userId})"]`);
                buttons.forEach(button => {
                    button.disabled = true;
                    button.textContent = "Request Sent";
                });
                fetchContacts();
            }
        })
        .catch(error => {
            console.error("Error sending friend request:", error);
            alert("Failed to send friend request");
        });
}

function acceptFriendRequest(requestId, senderUsername) {
    console.log("Accepting request ID:", requestId);
    const token = getCSRFToken();
    if (!token) {
        alert("CSRF token missing. Cannot proceed.");
        return;
    }

    fetch(`/accept_friend_request/${requestId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': token
        },
        credentials: 'same-origin'
    })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errData => {
                    throw new Error(errData.error || `Server responded with status: ${response.status}`);
                }).catch(() => {
                    throw new Error(`Network response was not ok. Status: ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log("Accept response data:", data);
            if (data.success) {
                const requestElement = document.querySelector(`#pending-requests div[data-request-id="${requestId}"]`);
                if (requestElement) {
                    const container = document.getElementById("pending-requests");
                    requestElement.remove();
                    console.log("Removed pending request item:", requestId);

                    if (container.children.length === 0) {
                        container.innerHTML = '<div class="no-requests">No pending requests</div>';
                    }

                    fetchFriends();
                } else {
                    console.warn("Could not find request element to remove for ID:", requestId);
                    fetchFriends();
                    alert("Friend accepted, but the list item could not be removed automatically.");
                }
            } else {
                alert(data.error || "Failed to accept friend request.");
            }
        })
        .catch(error => {
            console.error("Error accepting friend request:", error);
            alert("Failed to accept friend request. Please try again.");
        });
}

function rejectFriendRequest(requestId) {
    console.log("Rejecting request ID:", requestId);
    const token = getCSRFToken();
    if (!token) {
        alert("CSRF token missing. Cannot proceed.");
        return;
    }

    fetch(`/reject_friend_request/${requestId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': token
        },
        credentials: 'same-origin'
    })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errData => {
                    throw new Error(errData.error || `Server responded with status: ${response.status}`);
                }).catch(() => {
                    throw new Error(`Network response was not ok. Status: ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log("Reject response data:", data);
            if (data.success) {
                const requestElement = document.querySelector(`#pending-requests div[data-request-id="${requestId}"]`);
                if (requestElement) {
                    const container = document.getElementById("pending-requests");
                    requestElement.remove();
                    console.log("Removed pending request item:", requestId);

                    if (container.children.length === 0) {
                        container.innerHTML = '<div class="no-requests">No pending requests</div>';
                    }
                } else {
                    console.warn("Could not find request element to remove for ID:", requestId);
                    alert("Friend request rejected, but the list item could not be removed automatically.");
                }
            } else {
                alert(data.error || "Failed to reject friend request.");
            }
        })
        .catch(error => {
            console.error("Error rejecting friend request:", error);
            alert("Failed to reject friend request. Please try again.");
        });
}

function sendMessage() {
    const messageInput = document.getElementById("chat-message-input");
    const message = messageInput.value.trim();
    if (message !== "" && chatSocket && chatSocket.readyState === WebSocket.OPEN) {
        chatSocket.send(JSON.stringify({
            "message": message,
            "timestamp": getCurrentTimeFormatted()
        }));
        messageInput.value = "";
    } else if (!chatSocket || chatSocket.readyState !== WebSocket.OPEN) {
        console.error("WebSocket not connected");
        alert("You are not connected. Please try again later.");
    }
}

document.getElementById("send-button").onclick = sendMessage;

document.getElementById("chat-message-input").addEventListener("keypress", function(event) {
    if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
});

document.getElementById('search-form').addEventListener('submit', function(event) {
    event.preventDefault();
    fetchContacts();
});
</script>



<style>
  /* --- Base Styles and Star Animations --- */
  body {
    background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
    margin: 0;
    overflow-x: hidden;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    position: relative;
    color: #e0e0e0;
  }

  .star {
    position: fixed;
    top: -20px;
    background: #ffffff;
    border-radius: 50%;
    opacity: 0.8;
    z-index: 0;
    box-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
  }

  @keyframes fallingStar {
    to {
      transform: translateY(100vh);
      opacity: 0;
    }
  }

  /* --- Chat Container --- */
  .chat-container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    background: transparent;
  }

  /* --- Chat Header --- */
  .chat-header {
    display: flex;
    align-items: center;
    background: #1f1f1f;
    padding: 12px 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    z-index: 1;
    border-bottom: 1px solid #333;
  }

  .chat-header .left, .chat-header .right {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .chat-header .center {
    flex-grow: 1;
    text-align: center;
  }

  .chat-username {
    font-size: 1.5rem;
    font-weight: 600;
    background: linear-gradient(to right, #4CAF50, #2196F3);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    margin: 0;
  }

  .online-status-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    margin-top: 4px;
  }

  .status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
  }

  .status-dot.online {
    background: #4CAF50;
  }

  .status-dot.offline {
    background: #f44336;
  }

  .status-text {
    font-size: 0.9rem;
    color: #b0b0b0;
  }

  /* --- Buttons --- */
  #settings-button, #contacts-button, #create-group-button, #close-contacts, #notifications-button {
    background: #2a2a2a;
    color: #e0e0e0;
    border: 1px solid #444;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.95rem;
    transition: all 0.2s ease;
    position: relative;
  }

  #settings-button:hover, #contacts-button:hover, #create-group-button:hover, #close-contacts:hover, #notifications-button:hover {
    background: #3a3a3a;
    border-color: #666;
    color: #ffffff;
  }

  Copy
/* --- Notifications --- */
.notifications-container {
  position: relative;
}

.notification-badge {
  position: absolute;
  top: 0; /* Align with the top of the button */
  right: -12px; /* Shift to the right side, reduced from -8px */
  background: #f44336;
  color: #ffffff;
  border-radius: 50%;
  width: 16px; /* Reduced size for compactness */
  height: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.7rem; /* Smaller font for smaller badge */
  font-weight: bold;
}

  .notifications-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    background: #2a2a2a;
    border: 1px solid #444;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    z-index: 1000;
    width: 300px;
    max-height: 400px;
    overflow-y: auto;
    padding: 8px;
  }

  .notification-item {
    padding: 10px;
    border-bottom: 1px solid #444;
    cursor: pointer;
    color: #e0e0e0;
    font-size: 0.9rem;
  }

  .notification-item:hover {
    background: #3a3a3a;
  }

  .notification-item:last-child {
    border-bottom: none;
  }

  .notification-timestamp {
    font-size: 0.8rem;
    color: #b0b0b0;
    margin-top: 4px;
    display: block;
  }

  .no-notifications {
    padding: 10px;
    color: #b0b0b0;
    text-align: center;
    font-size: 0.9rem;
  }

  /* --- Settings Dropdown --- */
  .settings-container {
    position: relative;
  }

  .settings-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    background: #2a2a2a;
    border: 1px solid #444;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    z-index: 1000;
    width: 200px;
    padding: 8px;
  }

  .settings-dropdown button {
    background: transparent;
    color: #e0e0e0;
    border: none;
    padding: 10px;
    text-align: left;
    cursor: pointer;
    border-radius: 4px;
    width: 100%;
    font-size: 0.95rem;
  }

  .settings-dropdown button:hover {
    background: #3a3a3a;
  }

  .settings-divider {
    border: none;
    border-top: 1px solid #444;
    margin: 6px 0;
  }

  .settings-dropdown #userInfoDisplay {
    padding: 10px;
    color: #b0b0b0;
    font-size: 0.9rem;
  }

  /* --- Contacts Overlay --- */
  .contacts-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    overflow: auto;
  }

  .contacts-content {
    position: relative;
    background-color: #1a1a1a;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
    width: 90%;
    max-width: 800px;
    display: flex;
    flex-direction: row;
  }

  .contacts-left {
    width: 40%;
    padding: 20px;
    border-right: 1px solid #333;
    overflow-y: auto;
  }

  .contacts-right {
    width: 60%;
    padding: 20px;
    overflow-y: auto;
  }

  .contacts-left h3, .contacts-right h3 {
    font-size: 1.2rem;
    margin-bottom: 15px;
    color: #ffffff;
  }

  #close-contacts {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    color: #cccccc;
    border: none;
    font-size: 16px;
    cursor: pointer;
    transition: color 0.3s ease;
    z-index: 1001;
  }

  /* --- Search Form --- */
  #search-form {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
  }

  #search-query {
    flex: 1;
    padding: 10px;
    border: 1px solid #444;
    border-radius: 6px;
    background: #2a2a2a;
    color: #e0e0e0;
    font-size: 0.95rem;
  }

  #search-form button {
    background: #4CAF50;
    color: #ffffff;
    border: none;
    padding: 10px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.95rem;
  }

  #search-form button:hover {
    background: #45a049;
  }

  /* --- Contacts and Friends --- */
  #contacts-list, #friends-list, #groups-list, #pending-requests {
    padding: 0;
  }

  .contact-item, .friend-item, .group-item, .pending-request-item {
    display: flex;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #333;
    transition: background 0.2s ease;
  }

  .contact-item:hover, .friend-item:hover, .group-item:hover, .pending-request-item:hover {
    background: #2a2a2a;
  }

  .friend-status-indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 10px;
  }

  .friend-status-indicator.online {
    background: #4CAF50;
  }

  .friend-status-indicator.offline {
    background: #f44336;
  }

  .add-button, .message-button, .accept-button, .reject-button {
    background: #2a2a2a;
    color: #e0e0e0;
    border: 1px solid #444;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    margin-left: 10px;
  }

  .add-button:hover, .message-button:hover {
    background: #3a3a3a;
    border-color: #666;
  }

  .accept-button {
    background: #4CAF50;
    border-color: #4CAF50;
  }

  .reject-button {
    background: #f44336;
    border-color: #f44336;
  }

  .accept-button:hover, .reject-button:hover {
    opacity: 0.9;
  }

  /* --- Group Creation --- */
  #create-group-form {
    background: #2a2a2a;
    padding: 15px;
    border-radius: 8px;
    margin-top: 10px;
    box-sizing: border-box;
  }

  #group-name-input {
    width: 100%;
    padding: 10px;
    border: 1px solid #444;
    border-radius: 6px;
    background: #333;
    color: #e0e0e0;
    font-size: 0.95rem;
    margin-bottom: 10px;
    box-sizing: border-box;
  }

  .friend-checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 8px 0;
  }

  .friend-checkbox input {
    cursor: pointer;
  }

  .friend-checkbox label {
    color: #e0e0e0;
    font-size: 0.95rem;
  }

  #create-group-form button {
    background: #4CAF50;
    color: #ffffff;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    margin-right: 10px;
  }

  #create-group-form button:last-child {
    background: #f44336;
  }

  #create-group-form button:hover {
    opacity: 0.9;
  }

  /* --- Chat Section --- */
  #chat-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden; /* Prevent overflow issues */
  }

  .start-messaging {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: #b0b0b0;
  }

  .start-messaging h3 {
    font-size: 2rem;
    margin-bottom: 10px;
  }

  .start-messaging p {
    font-size: 1.1rem;
  }

  #chat-box {
    flex: 1;
    width: 80%;
    max-width: 1000px;
    margin: 20px auto;
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    display: flex;
    flex-direction: column;
    position: relative;
    z-index: 1;
    overflow: hidden; /* Ensure no overflow issues */
  }

  .messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    scrollbar-width: thin;
    scrollbar-color: #ccc transparent;
    max-height: calc(100% - 60px); /* Account for input section height */
    box-sizing: border-box;
  }

  .messages-container::-webkit-scrollbar {
    width: 8px;
  }

  .messages-container::-webkit-scrollbar-track {
    background: transparent;
  }

  .messages-container::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 4px;
  }

  /* --- Message Input --- */
  #message-input-section {
    position: relative; /* Changed from absolute to avoid breaking flex */
    background: #f5f5f5;
    padding: 12px;
    border-bottom-left-radius: 12px;
    border-bottom-right-radius: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
    z-index: 2;
  }

  #chat-message-input {
    flex: 1;
    padding: 12px 16px;
    font-size: 1rem;
    border: 1px solid #ddd;
    border-radius: 24px;
    background: #ffffff;
  }

  #send-button {
    background: #4CAF50;
    color: #ffffff;
    border: none;
    padding: 10px 20px;
    border-radius: 24px;
    cursor: pointer;
    font-size: 1rem;
    transition: background 0.2s ease;
  }

  #send-button:hover {
    background: #45a049;
  }

  /* --- Messages --- */
  .message-wrapper {
    display: flex;
    margin-bottom: 20px; /* Slightly reduced for balance */
    width: 100%;
  }

  .message-wrapper.own-message {
    justify-content: flex-end;
  }

  .message-wrapper > div {
    padding: 12px 16px; /* Standard padding */
    border-radius: 16px;
    max-width: 70%;
    word-break: break-word;
    position: relative;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    gap: 6px; /* Reduced gap for tighter but clear separation */
  }

  .own-message > div {
    background: #2c7be5;
    color: #ffffff;
    border-top-right-radius: 4px;
  }

  .message-wrapper:not(.own-message) > div {
    background: #f0f2f5;
    color: #333;
    border-top-left-radius: 4px;
  }

  .message-content {
    flex-grow: 1;
    line-height: 1.4;
  }
  .message-meta {
  display: flex;
  flex-direction: row !important; /* Change from column to row for horizontal alignment */
  justify-content: flex-end; /* Align items to the right */
  align-items: center; /* Vertically center items */
  font-size: 0.8rem;
  opacity: 0.7;
  color: inherit;
  gap: 8px; /* Add some space between timestamp and read receipt */
}
.read-receipt {
  order: 1 !important;
}
.message-timestamp {
  order: 2 !important;
  color: #ffffff; /* Ensure visibility on own messages */
}

  /* --- Disabled State --- */
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: #555 !important;
    border-color: #777 !important;
  }

  /* --- Responsive Design --- */
  @media (max-width: 768px) {
    #chat-box {
      width: 95%;
    }

    .contacts-content {
      flex-direction: column;
      width: 95%;
      height: 90%;
    }

    .contacts-left, .contacts-right {
      width: 100%;
      border-right: none;
      border-bottom: 1px solid #333;
    }

    .chat-header {
      padding: 10px;
    }

    .chat-username {
      font-size: 1.2rem;
    }

    #settings-button, #contacts-button, #notifications-button {
      padding: 6px 12px;
      font-size: 0.9rem;
    }

    .notifications-dropdown {
      width: 250px;
    }

    .message-meta {
      font-size: 0.75rem; /* Slightly smaller on mobile */
    }

    .message-wrapper > div {
      gap: 4px; /* Tighter gap on mobile */
    }

    .messages-container {
      max-height: calc(100% - 56px); /* Adjust for smaller input section */
    }
  }
</style>
{% endblock %}